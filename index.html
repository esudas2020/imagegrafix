<!DOCTYPE html>
<html>

<head>
    <title>App Default Screen</title>    
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	
    <script src="https://code.jquery.com/jquery-3.6.1.js"></script>
    <style>
        div.a {
            line-height: 200%;
        }
    </style>
    <script>       	    
	    
var params = new URL(window.location).searchParams;
var project_desc = params.get('project_desc');		
//var milestone_id = params.get('milestone_id');
//var milestone = params.get('milestone');
var project_id = params.get('project_id');
	    var portal_id = "60004006068";
	    var invoiceurl = "https://softwaresolutions.imagegrafix.in:8089/invoice";
	    var refresh_token = "1000.854d65ca9c39e1a2d218251b74f9003b.a56a440d96dc721b5a453024cd33c044";
	    var client_id = "1000.5Y3AZV8FIIVVH6VZJU0Y6726IEET6J";
	    var client_secret = "bf29f2e7680b5dde78d746d0ae4236ace7d88ef792";
	    
        function populateSelect() {
		
		var apiEndpoint = "https://accounts.zoho.in/oauth/v2/token?refresh_token=" + refresh_token + "&client_id=" + client_id + "&client_secret=" + client_secret +  "&grant_type=refresh_token";
		const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
		//https://cors-anywhere.herokuapp.com/corsdemo
		 const fullUrl = proxyUrl + apiEndpoint;
		 const xhr = new XMLHttpRequest();

    // Initialize a POST request to the full URL
    xhr.open('POST', fullUrl, true);

    // Set request headers
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

    // Define the response handling logic
    xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
            const response = JSON.parse(xhr.responseText);
//document.getElementById('response').innerText = 'Response: ' + JSON.stringify(response, null, 2);
		
		const jsonResponse = JSON.parse(xhr.responseText);
            const accessToken = jsonResponse.access_token;
 //document.getElementById('token').innerText = accessToken;
				
		var apiEndpoint1 = "https://projectsapi.zoho.in/restapi/portal/" +  portal_id + "/projects/" + project_id + "/milestones/";

		 const gfullUrl = proxyUrl + apiEndpoint1;
		 const gxhr = new XMLHttpRequest();
		 gxhr.open('GET', gfullUrl, true);
		 gxhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
		 gxhr.setRequestHeader('Authorization', 'Zoho-oauthtoken ' + accessToken); // Replace accessToken with your actual token

		 gxhr.onload = function() {
        if (gxhr.status >= 200 && gxhr.status < 300) {
            const response = JSON.parse(gxhr.responseText);
		
            //document.getElementById('response').innerText = 'Response: ' + JSON.stringify(response, null, 2);

		const gjsonResponse = JSON.parse(gxhr.responseText);
//alert(gjsonResponse.milestones.length);
		for (var i = 0; i < gjsonResponse.milestones.length; i++) {
    var select = document.getElementById("Select");
    var option = document.createElement("option");
    option.text = gjsonResponse.milestones[i].name;
    option.value = gjsonResponse.milestones[i].id;
    select.add(option);
}		
        } else {
            document.getElementById('response').innerText = 'Error: ' + gxhr.status + ' - ' + gxhr.statusText;
        }
    };
    // Handle request errors
    gxhr.onerror = function() {
        document.getElementById('response').innerText = 'Request failed.';
    };
    gxhr.send();//get miletones request		
            
        } else {
            document.getElementById('response').innerText = 'Error: ' + xhr.status + ' - ' + xhr.statusText;
        }
    };

    // Handle request errors
    xhr.onerror = function() {
        document.getElementById('response').innerText = 'Request failed.';
    };

    // Send the request with the JSON-encoded data
    //xhr.send(JSON.stringify(postData));
		xhr.send(); //post request to access token
	}
	    
	function showInvoiceList() {
            window.open(invoiceurl + "/InvoiceList?Refference=" + project_desc);
        }

        function createInvoice() {		
		
		const selectElement = document.getElementById('Select');
            
		const selectedIndex = selectElement.selectedIndex; // Get the index of the selected option
            
		const selectedOption = selectElement.options[selectedIndex]; // Get the selected option
		
		milestone = selectedOption.text
		
		milestone_id = selectedOption.value;
		
		window.open(invoiceurl + "/index?MileStone=" + milestone + "&Refference=" + project_desc + "&Milestone ID=" + milestone_id + "&Projectid=" + project_id);
        }

	    document.addEventListener('DOMContentLoaded', (event) => {
            populateSelect();
        });
	    
    </script>
</head>

<body>
    	<p id="demo" style="font-size:20px"> </p>

	<form class="row g-3">
	
		<div class="col-auto">	
			<label for="selectmilestone" class="form-label">&nbsp;Select Milestone</label>
		</div>		
		<div class="col-auto">	
			<select class="form-select" id="Select" name="MileStoneList" aria-label="Default select example"></select>
		</div>
		<div class="col-auto">	
			<button onclick="createInvoice()" type="button" class="btn btn-primary">Create Invoice</button>
		</div>		
		<div class="col-auto">
			<button onclick="showInvoiceList()" type="button" class="btn btn-primary">Show Invoice List</button>
		</div>
	
	</div>
		
	<div id="token"></div>
	
 	<div id="response"></div>
</body>

</html>
